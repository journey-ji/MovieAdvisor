<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영화추천 시스템</title>
    <link rel="stylesheet" href="./static/css/reset.css">
    <link rel="stylesheet" href="./static/css/style.css">
    <script src="./static/js/slider.js" defer></script>
</head>
<body>
    <header>
        <nav class="nav-bar">
            <h1>Movie Advisor</h1>
        </nav>
    </header>
    <main>
        <div class="wrap">
            <div class="cont-hero">
            </div>
            <div class="cont-movies">
                <h2 class="tit-movies">추천영화</h2>
                <ul>
                    <li class="item-movie"><img id="img1" src="./static/img/sample1.jpg" alt=""></li>
                    <li class="item-movie"><img id="img2" src="./static/img/sample1.jpg" alt=""></li>
                    <li class="item-movie"><img id="img3" src="./static/img/sample1.jpg" alt=""></li>
                    <li class="item-movie"><img id="img4" src="./static/img/sample1.jpg" alt=""></li>
                    <li class="item-movie"><img id="img5" src="./static/img/sample1.jpg" alt=""></li>
                    <li class="item-movie"><img id="img6" src="./static/img/sample1.jpg" alt=""></li>
                    <li class="item-movie"><img id="img7" src="./static/img/sample1.jpg" alt=""></li>
                    <li class="item-movie"><img id="img8" src="./static/img/sample1.jpg" alt=""></li>
                    <li class="item-movie"><img id="img9" src="./static/img/sample1.jpg" alt=""></li>
                    <li class="item-movie"><img id="img10" src="./static/img/sample1.jpg" alt=""></li>
                </ul>
            </div>
            <div class="row">
                <div class="header-slider">
                    <h2 class="tit-movies">최근 인기 컨텐츠</h2>
                    <div class="progress-bar">
                        <div class="progress-item active"></div>
                        <div class="progress-item"></div>
                        <div class="progress-item"></div>
                        <div class="progress-item"></div>
                    </div>
                </div>
                <div class="cont-trending">
                    <button class="handle left-handle">
                        <div class="text">&#8249;</div>
                    </button>
                    <div class="slider">
                        <img id="trend-img1" src="https://via.placeholder.com/210/000000?text=1" alt="">
                        <img id="trend-img2" src="https://via.placeholder.com/210/000000?text=2" alt="">
                        <img id="trend-img3" src="https://via.placeholder.com/210/000000?text=3" alt="">
                        <img id="trend-img4" src="https://via.placeholder.com/210/000000?text=4" alt="">
                        <img id="trend-img5" src="https://via.placeholder.com/210/000000?text=5" alt="">
                        <img id="trend-img6" src="https://via.placeholder.com/210/000000?text=6" alt="">
                        <img id="trend-img7" src="https://via.placeholder.com/210/000000?text=7" alt="">
                        <img id="trend-img8" src="https://via.placeholder.com/210/000000?text=8" alt="">
                        <img id="trend-img9" src="https://via.placeholder.com/210/000000?text=9" alt="">
                        <img id="trend-img10" src="https://via.placeholder.com/210/000000?text=10" alt="">
                        <img id="trend-img11" src="https://via.placeholder.com/210/000000?text=11" alt="">
                        <img id="trend-img12" src="https://via.placeholder.com/210/000000?text=12" alt="">
                    </div>
                    <button class="handle right-handle">
                        <div class="text">&#8250;</div>
                    </button>
                </div>
            </div>



            <div class="weather">
                <div class="header-slider">
                    <h2 class="tit-movies">오늘날씨 추천영화</h2>
                    <div class="progress-bar">
                        <div class="progress-item active"></div>
                        <div class="progress-item"></div>
                        <div class="progress-item"></div>
                        <div class="progress-item"></div>
                    </div>
                </div>
                <div class="cont-trending">
                    <button class="handle left-handle">
                        <div class="text">&#8249;</div>
                    </button>
                    <div class="slider">
                        <img id="weather-img1" src="https://via.placeholder.com/210/000000?text=1" alt="">
                        <img id="weather-img2" src="https://via.placeholder.com/210/000000?text=2" alt="">
                        <img id="weather-img3" src="https://via.placeholder.com/210/000000?text=3" alt="">
                        <img id="weather-img4" src="https://via.placeholder.com/210/000000?text=4" alt="">
                        <img id="weather-img5" src="https://via.placeholder.com/210/000000?text=5" alt="">
                        <img id="weather-img6" src="https://via.placeholder.com/210/000000?text=6" alt="">
                        <img id="weather-img7" src="https://via.placeholder.com/210/000000?text=7" alt="">
                        <img id="weather-img8" src="https://via.placeholder.com/210/000000?text=8" alt="">
                        <img id="weather-img9" src="https://via.placeholder.com/210/000000?text=9" alt="">
                        <img id="weather-img10" src="https://via.placeholder.com/210/000000?text=10" alt="">
                        <img id="weather-img11" src="https://via.placeholder.com/210/000000?text=11" alt="">
                        <img id="weather-img12" src="https://via.placeholder.com/210/000000?text=12" alt="">
                    </div>
                    <button class="handle right-handle">
                        <div class="text">&#8250;</div>
                    </button>
                </div>
            </div>
            
        </div>
    </main>
    <footer></footer>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script>

        const API = '';
        let posterPath='';
        let movieId = 19995

        const imageURL = `https://image.tmdb.org/t/p/original/${posterPath}`
        let movieURL = `https://api.themoviedb.org/3/movie/${movieId}?api_key=${API}&language=ko`
        let avatar = 'https://image.tmdb.org/t/p/original/gC3tW9a45RGOzzSh6wv91pFnmFr.jpg'
        let movieList = {
            img1 :null,
            img2 :null,
            img3 :null,
            img4 :null,
            img5 :null,
            img6 :null,
            img7 :null,
            img8 :null,
            img9 :null,
            img10 :null,
        }

        function data_fetch(data) {
            // 1. 처음 페이지 로드할 때,
            // 2. 이미지 눌러서 데이터 받아왔을 때

            // 초기 파이썬 데이터 받아오기
            if(data==='first-page-load'){
                fetch("http://localhost:3000/test")
                .then(response => response.json())
                .then(response => {
                    // 입력받은 문자열을 movieId & title 로 나뉜 배열로 반환
                    // 아마 윈도우랑 맥의 공백차이 때문에 잘못작동하는 듯
                    // 윈도우는 \r\n으로 처리가능 Unix, Linux 는 \n
                    let temp = response.split(/\r\n|\r|\n/).filter((ele,idx)=>idx<=10&&idx>0)
                    temp.forEach((e,idx,arr) => {
                        arr[idx] = e.replace(' ',',').split(',')
                        arr[idx][1] = arr[idx][1].trim()
                        arr[idx] = arr[idx][1].replace(' ',',').split(',')
                        arr[idx][1] = arr[idx][1].trim()
                        arr[idx][0] = parseInt(arr[idx][0])
                    });
                    
                    
                    
                    // 10개 영화 포스터 입력 함수화하기
                    // 음,,, 저장할 목록 : imagepath, 
                    for(let i=0; i<10;i++){
                        // 클라이언트의 영화목록에 movieId 저장
                        movieList[`img${i+1}`] = parseInt(temp[i][0])
                        fetch(`https://api.themoviedb.org/3/movie/${temp[i][0]}?api_key=${API}&language=ko`)
                        .then(response=>response.json())
                        .then(response=>{
                            document.querySelector(`#img${i+1}`).setAttribute('src','https://image.tmdb.org/t/p/original'+response.poster_path)
                            document.querySelector(`#img${i+1}`).setAttribute('data-value',response.id)
                        })
                    }
                    
                })
            }else{
                let temp = data.split(/\r\n|\r|\n/).filter((ele,idx)=>idx<=10&&idx>0)
                temp.forEach((e,idx,arr) => {
                    arr[idx] = e.replace(' ',',').split(',')
                    arr[idx][1] = arr[idx][1].trim()
                    arr[idx] = arr[idx][1].replace(' ',',').split(',')
                    arr[idx][1] = arr[idx][1].trim()
                    arr[idx][0] = parseInt(arr[idx][0])
                });
                
                for(let i=0; i<10;i++){
                    // 클라이언트의 영화목록에 movieId 저장
                    movieList[`img${i+1}`] = parseInt(temp[i][0])
                    fetch(`https://api.themoviedb.org/3/movie/${temp[i][0]}?api_key=${API}&language=ko`)
                    .then(response=>response.json())
                    .then(response=>{
                        document.querySelector(`#img${i+1}`).setAttribute('src','https://image.tmdb.org/t/p/original'+response.poster_path)
                        document.querySelector(`#img${i+1}`).setAttribute('data-value',response.id)
                    })
                }
            }
        }
        
        


        // 10개의 이미지에 대하여 클릭시 이벤트 설정
        // 이미지 클릭하면, 동작되어야 할 일
        // 1. 해당 이미지에 대한 데이터 전송 ㅇㅋ 
        // 2. 서버에서 데이터 받아서, 선호리스트에 데이터 저장 후, ㅇㅋ 
        // 3. 파이썬에 해당 선호리스트 보내서 다시 10개의 영화 추천 ㅇㅋ
        // 4. 추천된 10개의 영화에 대한 데이터를 다시 클라이언트에게 보내줌 localhost:3000/test로
        // 10월 24일 이미지클릭 이벤트 구현 완료
        function imageClick_set(){
            for(let i=1; i<=10;i++){
                $(function(){
                    $(`#img${i}`).click(function(){   //submit 버튼을 클릭하였을 때
                        let imgId = document.querySelector(`#img${i}`).getAttribute('data-value')
                        fetch(`https://api.themoviedb.org/3/movie/${imgId}?api_key=${API}&language=ko`)
                            .then(response=>response.json())
                            .then(data=>{
                                console.log(`Title : ${data.title}`)
                                console.log(`${data.overview}`)
                            })
                        
                        $.ajax({
                            type:'post',   //post 방식으로 전송
                            url:'/test',   //데이터를 주고받을 파일 주소
                            data: {
                                name : `${i}번째 아이템`,
                                movieId : parseInt(movieList[`img${i}`]),
                            },
                            dataType:'json',   //json 파일 형식으로 값을 담아온다.
                            success : function(data){   //파일 주고받기가 성공했을 경우
                                data_fetch(data)
                            },
                            error : function(err) {     // 실패 시
                                console.log("failed : " + err);
                            }
                        });
                    });
                });
            }
        }



        // 오늘의 트렌드 영화 
        const tredingMoiveList = ()=>{
            fetch('https://api.themoviedb.org/3/trending/all/day?api_key=3978573dbb0bb023a5f7c9fbb4d079aa&language=ko-KR')
            .then(response=>response.json())
            .then(data =>{
                // console.log(data)
                for(let i =0; i<12;i++){
                    document.querySelector(`#trend-img${i+1}`).setAttribute('src','https://image.tmdb.org/t/p/original'+data['results'][i]['poster_path'])
                }
            })
        }


        // 날씨별 추천 영화 
        
        const weatherRecomMovieList = (data)=>{
            if(data){
                let temp = data.split(/\r\n|\r|\n/).filter((ele,idx)=>idx<=12&&idx>0)
                        temp.forEach((e,idx,arr) => {
                            arr[idx] = e.replace(' ',',').split(',')
                            arr[idx][1] = arr[idx][1].trim()
                            arr[idx] = arr[idx][1].replace(' ',',').split(',')
                            arr[idx][1] = arr[idx][1].trim()
                            arr[idx][0] = parseInt(arr[idx][0])
                        });
                    movieUrl = ''
                    
                    for(let i =0; i<12;i++){
                       // document.querySelector(`#weather-img${i+1}`).setAttribute('src','https://image.tmdb.org/t/p/original'+movieUrl)
                    }
                    for(let i=0; i<12;i++){
                        fetch(`https://api.themoviedb.org/3/movie/${temp[i][0]}?api_key=${API}&language=ko`)
                        .then(response=>response.json())
                        .then(response=>{
                            document.querySelector(`#weather-img${i+1}`).setAttribute('src','https://image.tmdb.org/t/p/original'+response.poster_path)
                        })
                    }
            }else{
                fetch('http://localhost:3000/weather')
                .then(response=>response.json())
                .then(data=>{
                    
                    let temp = data.split(/\r\n|\r|\n/).filter((ele,idx)=>idx<=12&&idx>0)
                        temp.forEach((e,idx,arr) => {
                            arr[idx] = e.replace(' ',',').split(',')
                            arr[idx][1] = arr[idx][1].trim()
                            arr[idx] = arr[idx][1].replace(' ',',').split(',')
                            arr[idx][1] = arr[idx][1].trim()
                            arr[idx][0] = parseInt(arr[idx][0])
                        });
                    console.log(temp)
                    movieUrl = ''
                    
                    for(let i =0; i<12;i++){
                       // document.querySelector(`#weather-img${i+1}`).setAttribute('src','https://image.tmdb.org/t/p/original'+movieUrl)
                    }
                    for(let i=0; i<12;i++){
                        fetch(`https://api.themoviedb.org/3/movie/${temp[i][0]}?api_key=${API}&language=ko`)
                        .then(response=>response.json())
                        .then(response=>{
                            document.querySelector(`#weather-img${i+1}`).setAttribute('src','https://image.tmdb.org/t/p/original'+response.poster_path)
                        })
                    }
                })
            }
        }


        API_KEY_WEATHER = ''
        function getWeather(lat, lon) {
            fetch(
                `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY_WEATHER}&units=metric`
            )
            .then(response=>response.json())
            .then(data=>{
                let todayWeather = data.weather[0].main
                $.ajax({
                    type:'post',   //post 방식으로 전송
                    url:'/weather',   //데이터를 주고받을 파일 주소
                    data: {
                        name : `날씨`,
                        weather : data.weather[0].main,
                    },
                    dataType:'json',   //json 파일 형식으로 값을 담아온다.
                    success : function(data){   //파일 주고받기가 성공했을 경우
                        console.log('오늘의 날씨 : '+todayWeather)
                        weatherRecomMovieList(data)
                    },
                    error : function(err) {     // 실패 시
                        console.log("failed : " + err);
                    }
                });
            })
        }


        data_fetch('first-page-load')
        imageClick_set()
        tredingMoiveList()
        getWeather(37.2428,127.0798)
        //weatherRecomMovieList()

    </script>
    
</body>
</html>

<!-- 할 일 
 1. 오늘의 날씨 api 받아오기  기상청 ?
 2.
 3. 


 11월 9일 최근 인기영화 캐러셀 추가 

 11월 11일 fetch 데이터에 대한 윈도우와 맥 개행문자 처리 완료
 11월 11일 최근 인기 컨텐츠 캐러셀(progress-bar)작업 완료
 11월 14일 오늘날씨 추천영화 CSS HTML 완료
 11월 14일 오늘날씨 추천영화 구현 완료 (기상청 날씨 api 연동 필요)
 11월 22일 현재 날씨 받아오기 완료
 11월 23일 받아온 날씨에 맞는 영화추천하기 완료 (추천시스템에 단어데이터셋 업데이트 필요)
-->